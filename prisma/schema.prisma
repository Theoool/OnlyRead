generator client {
  provider        = "prisma-client-js"
  output          = "../lib/generated/prisma"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pg_trgm, uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id               String            @id @default(uuid()) @db.Uuid
  email            String            @unique
  fullName         String?           @map("full_name")
  avatarUrl        String?           @map("avatar_url")
  subscriptionType String            @default("free") @map("subscription_type") @db.VarChar(50)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  lastActiveAt     DateTime          @default(now()) @map("last_active_at")
  articleChunks    ArticleChunk[]
  articles         Article[]
  collections      Collection[]
  concepts         Concept[]
  jobs             Job[]
  learningSessions LearningSession[]
  readingSessions  ReadingSession[]
  readingStats     ReadingStats?
  reviewHistory    ReviewHistory[]
  tags             Tag[]
  settings         UserSettings?

  @@index([id])
  @@map("users")
}

model UserSettings {
  userId        String  @id @map("user_id") @db.Uuid
  theme         String  @default("system")
  language      String  @default("zh-CN")
  dailyGoal     Int     @default(10) @map("daily_goal")
  notifications Boolean @default(true)
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Article {
  id               String                   @id @default(uuid()) @db.Uuid
  userId           String                   @map("user_id") @db.Uuid
  title            String?                  @db.VarChar(1000)
  url              String?
  domain           String?                  @db.VarChar(255)
  summary          String?
  type             String                   @default("markdown") @db.VarChar(50)
  searchVector     Unsupported("tsvector")?
  embedding        Unsupported("vector")?
  progress         Int                      @default(0) @db.SmallInt
  currentPosition  Int                      @default(0) @map("current_position")
  totalBlocks      Int                      @default(0) @map("total_blocks")
  completedBlocks  Int                      @default(0) @map("completed_blocks")
  readingStartTime DateTime?                @map("reading_start_time")
  readingEndTime   DateTime?                @map("reading_end_time")
  totalReadingTime Int                      @default(0) @map("total_reading_time")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")
  deletedAt        DateTime?                @map("deleted_at")
  collectionId     String?                  @map("collection_id") @db.Uuid
  order            Int?                     @default(0)
  parentId         String?                  @map("parent_id") @db.Uuid
  body             ArticleBody?
  chunks           ArticleChunk[]
  collection       Collection?              @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  parent           Article?                 @relation("ArticleToArticle", fields: [parentId], references: [id])
  children         Article[]                @relation("ArticleToArticle")
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  concepts         Concept[]
  readingSessions  ReadingSession[]

  @@unique([collectionId, order])
  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, collectionId, createdAt(sort: Desc)])
  @@index([userId, type, createdAt(sort: Desc)])
  @@index([parentId])
  @@index([searchVector], type: Gin)
  @@map("articles")
}

model ArticleBody {
  articleId String  @id @map("article_id") @db.Uuid
  content   String
  markdown  String?
  html      String?
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@map("article_bodies")
}

model Collection {
  id                String    @id @default(uuid()) @db.Uuid
  title             String
  description       String?
  cover             String?
  type              String    @default("SERIES")
  userId            String    @map("user_id") @db.Uuid
  author            String?   @db.VarChar(255)
  language          String?   @default("zh-CN") @db.VarChar(10)
  isbn              String?   @unique @db.VarChar(50)
  totalChapters     Int       @default(0) @map("total_chapters")
  completedChapters Int       @default(0) @map("completed_chapters")
  readingProgress   Float?    @default(0) @map("reading_progress")
  totalWords        BigInt?   @map("total_words")
  estimatedReadTime Int?      @map("estimated_read_time")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  articles          Article[]
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, updatedAt(sort: Desc)])
  @@map("collections")
}

model Concept {
  id                String                 @id @default(uuid()) @db.Uuid
  userId            String                 @map("user_id") @db.Uuid
  term              String                 @db.VarChar(255)
  myDefinition      String                 @map("my_definition")
  myExample         String                 @map("my_example")
  myConnection      String?                @map("my_connection")
  confidence        Int                    @default(3) @db.SmallInt
  aiDefinition      String?                @map("ai_definition")
  aiExample         String?                @map("ai_example")
  aiRelatedConcepts Json?                  @default("[]") @map("ai_related_concepts")
  embedding         Unsupported("vector")?
  sourceArticleId   String?                @map("source_article_id") @db.Uuid
  isAiCollected     Boolean                @default(false) @map("is_ai_collected")
  lastReviewedAt    DateTime?              @map("last_reviewed_at")
  reviewCount       Int                    @default(0) @map("review_count")
  nextReviewDate    DateTime?              @map("next_review_date")
  easeFactor        Decimal                @default(2.5) @map("ease_factor") @db.Decimal(5, 2)
  interval          Int                    @default(0)
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  deletedAt         DateTime?              @map("deleted_at")
  article           Article?               @relation(fields: [sourceArticleId], references: [id])
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewHistory     ReviewHistory[]
  tags              TagsOnConcepts[]

  @@index([userId])
  @@index([userId, nextReviewDate])
  @@index([userId, term])
  @@index([sourceArticleId])
  @@map("concepts")
}

model Tag {
  id       String           @id @default(uuid()) @db.Uuid
  name     String           @db.VarChar(50)
  userId   String           @map("user_id") @db.Uuid
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  concepts TagsOnConcepts[]

  @@unique([userId, name])
  @@map("tags")
}

model TagsOnConcepts {
  conceptId  String   @map("concept_id") @db.Uuid
  tagId      String   @map("tag_id") @db.Uuid
  assignedAt DateTime @default(now())
  concept    Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([conceptId, tagId])
  @@map("tags_on_concepts")
}

model Job {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      JobType
  status    JobStatus @default(PENDING)
  payload   Json?
  result    Json?
  progress  Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("jobs")
}

model ArticleChunk {
  id          String                 @id @default(uuid()) @db.Uuid
  userId      String                 @map("user_id") @db.Uuid
  articleId   String                 @map("article_id") @db.Uuid
  order       Int
  content     String
  embedding   Unsupported("vector")?
  startOffset Int?                   @map("start_offset")
  endOffset   Int?                   @map("end_offset")
  createdAt   DateTime               @default(now()) @map("created_at")
  article     Article                @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([articleId])
  @@map("article_chunks")
}

model ReviewHistory {
  id         String   @id @default(uuid()) @db.Uuid
  conceptId  String   @map("concept_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  quality    Int      @db.SmallInt
  interval   Int
  easeFactor Decimal  @map("ease_factor") @db.Decimal(5, 2)
  reviewedAt DateTime @default(now()) @map("reviewed_at")
  sessionId  String?  @map("session_id") @db.Uuid
  concept    Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conceptId])
  @@index([userId])
  @@index([userId, reviewedAt(sort: Desc)])
  @@map("review_history")
}

model ReadingSession {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  articleId       String?   @map("article_id") @db.Uuid
  durationSeconds Int       @map("duration_seconds")
  blocksCompleted Int       @default(0) @map("blocks_completed")
  conceptsCreated Int       @default(0) @map("concepts_created")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  article         Article?  @relation(fields: [articleId], references: [id])
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, startedAt(sort: Desc)])
  @@map("reading_sessions")
}

model ReadingStats {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @unique @map("user_id") @db.Uuid
  totalArticles    Int       @default(0) @map("total_articles")
  totalReadingTime BigInt    @default(0) @map("total_reading_time")
  totalSessions    Int       @default(0) @map("total_sessions")
  currentStreak    Int       @default(0) @map("current_streak")
  longestStreak    Int       @default(0) @map("longest_streak")
  lastReadDate     DateTime? @map("last_read_date") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("reading_stats")
}

model LearningSession {
  id               String            @id @default(uuid()) @db.Uuid
  userId           String            @map("user_id") @db.Uuid
  title            String?           @db.VarChar(255)
  type             SessionType       @default(LEARNING)
  status           SessionStatus     @default(ACTIVE)
  mode             ModeType          @default(TUTOR)
  context          Json?             @default("{}")
  summary          String?
  summaryUpdatedAt DateTime?         @map("summary_updated_at")
  lastActivityAt   DateTime          @default(now()) @map("last_activity_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  messages         LearningMessage[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status, lastActivityAt(sort: Desc)])
  @@index([userId, type, status])
  @@map("learning_sessions")
}

model LearningMessage {
  id        String          @id @default(uuid()) @db.Uuid
  sessionId String          @map("session_id") @db.Uuid
  role      MessageRole
  content   String?
  ui        Json?
  sources   Json?
  metadata  Json?           @default("{}")
  createdAt DateTime        @default(now()) @map("created_at")
  session   LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("learning_messages")
}

enum SessionType {
  LEARNING
  COPILOT
  QA
}

enum SessionStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum ModeType {
  QA
  TUTOR
  COPILOT
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum JobType {
  IMPORT_FILE
  GENERATE_EMBEDDING
  AI_ANALYSIS
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
